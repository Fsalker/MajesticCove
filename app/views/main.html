<head>
    <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap/dist/css/bootstrap.min.css"/>
    <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css"/>
    <!--<link rel="stylesheet" type="text/css" href="theme.css">-->
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="//unpkg.com/babel-polyfill@latest/dist/polyfill.min.js"></script>
    <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
    <!--<script src="https://cdn.jsdelivr.net/npm/vue-resource@1.5.1"></script>-->
</head>

<body>
    <div id="app">
        <nav class="navbar navbar-expand-sm navbar-light bg-light">
            <a class="navbar-brand" href="#">Majestic Cove</a>

            <template v-if="!loggedin">
                <div class="ml-auto">
                    <button id="login" class="btn btn-outline-primary">Login</button>
                    <button id="register" class="btn btn-primary">Register</button>

                    <b-popover target="login" triggers="focus" placement="auto" title="Login">
                        <b-alert show v-bind:variant="login_response_variant" v-if="login_response">{{login_response}}</b-alert>
                        <div class="form-row">
                            <div class="col-sm-3 col-form-label">
                                <label for="login_user">Username</label>
                            </div>
                            <div class="col-sm-9">
                                <input id="login_user" class="form-control" v-model="login_user" @keydown.enter="login">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-sm-3 col-form-label">
                                <label for="login_pass">Password</label>
                            </div>
                            <div class="col-sm-9">
                                <input type="password" id="login_pass" class="form-control" v-model="login_pass" @keydown.enter="login">
                            </div>
                        <div>
                        <div class="mt-2">
                            <button class="btn btn-success" v-on:click="login">Login</button>
                            <img src="Loading.gif" v-if="showLoadingLogin">
                        </div>
                    </b-popover>

                    <b-popover target="register" triggers="focus" placement="auto" title="Register">
                        <b-alert show v-bind:variant="register_response_variant" v-if="register_response">{{register_response}}</b-alert>
                        <div class="form-row">
                            <div class="col-sm-3 col-form-label">
                                <label for="register_user">Username</label>
                            </div>
                            <div class="col-sm-9">
                                <input id="register_user" class="form-control" v-model="register_user" @keydown.enter="register">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-sm-3 col-form-label">
                                <label for="register_pass">Password</label>
                            </div>
                            <div class="col-sm-9">
                                <input type="password" id="register_pass" class="form-control" v-model="register_pass" @keydown.enter="register">
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-success" v-on:click="register">Register</button>
                            <img src="Loading.gif" v-if="showLoadingRegister">
                        </div>
                    </b-popover>
                </div>
            </template>
            <template v-else>
                <div class="ml-auto">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item ">
                            <div class="nav-link text-primary" style="display: inline-block">{{username}}</div>
                        </li>
                        <li>
                            <button class="btn btn-primary" v-on:click="logout">Log Out</button>
                        </li>
                </div>
            </template>
        </nav>
        <template v-if="showDebugData">
            Login username = {{login_user}}<br>
            Login password = {{login_pass}}<br>
            Register username = {{register_user}}<br>
            Register password = {{register_pass}}<br>
            Register Response = {{register_response}}<br>
            Login Response = {{login_response}}<br>
            Username = {{username}}<br>
            Session ID = {{ssid}}<br>
        </template>
    </div>
    <script>
        const COOKIE_LIFETIME_DAYS = 1;

        function setCookie(cname, cvalue, exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            var expires = "expires="+ d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }

        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i <ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        function deleteCookie(cname){
            setCookie(cname, null, 0);
        }

        var app = new Vue({
            el: "#app",
            data: {
                login_user: null,
                login_pass: null,
                register_user: null,
                register_pass: null,
                register_response: null,
                register_response_variant: null,
                login_response: null,
                username: getCookie("username"),
                ssid: getCookie("ssid"),
                showDebugData: true,
                showLoadingLogin: false,
                showLoadingRegister: false
            },
            computed: {
                loggedin: function(){
                    return this.ssid;
                }
            },
            methods: {
                login(){
                    this.showLoadingLogin = true;

                    data = {
                        user: this.login_user,
                        pass: this.login_pass
                    }

                    var req = new XMLHttpRequest();
                    req.onreadystatechange = function(){
                        if(this.readyState == 4){
                            app.showLoadingLogin = false;
                            console.log(this.response);
                            if(this.status == 200){
                                res = JSON.parse(this.response)
                                app.login_pass = null

                                app.ssid = res.ssid
                                app.username = data.user
                                setCookie("ssid", res.ssid, COOKIE_LIFETIME_DAYS)
                                setCookie("username", data.user, COOKIE_LIFETIME_DAYS)

                                app.login_response = "Logged in successfully!"
                                app.login_response_variant = "success";
                            }
                            else {
                                app.login_response = this.responseText
                                app.login_response_variant = "danger";
                            }
                        }
                    }

                    req.open("POST", "login")
                    req.setRequestHeader("content-type", "application/json")
                    req.send(JSON.stringify(data));
                },
                register(){
                    this.showLoadingRegister = true;

                    data = {
                        user: this.register_user,
                        pass: this.register_pass
                    }

                    var req = new XMLHttpRequest();
                    req.onreadystatechange = function(){
                        if(this.readyState == 4){
                            app.showLoadingRegister = false
                            if(this.status == 200){
                                res = JSON.parse(this.response)

                                app.ssid = res.ssid
                                app.username = data.user

                                setCookie("ssid", res.ssid, COOKIE_LIFETIME_DAYS)
                                setCookie("username", data.user, COOKIE_LIFETIME_DAYS)

                                app.register_response = "Registered successfully!"
                                app.register_response_variant = "success"
                            }
                            else {
                                app.register_response = this.responseText
                                app.register_response_variant = "danger"
                            }
                        }
                    }
                    req.open("POST", "/register")
                    req.setRequestHeader("content-type", "application/json")
                    console.log(data)
                    req.send(JSON.stringify(data))
                },
                logout(){
                    var req = new XMLHttpRequest();
                    req.open("POST", "/logout")
                    req.setRequestHeader("content-type", "application/json")
                    req.send(JSON.stringify({ssid: this.ssid}));

                    this.username = null
                    this.ssid = null
                    deleteCookie("username")
                    deleteCookie("ssid")

                    app.register_response = null
                    app.login_response = null
                }
            }
        });
    </script>
</body>